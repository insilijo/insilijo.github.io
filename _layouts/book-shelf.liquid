---
layout: page
---
{{ content }}

{% if page.collection and page.collection.size > 0 %}
  {% assign collection = site[page.collection] %}
{% endif %}

{% if collection and collection.size > 0 %}
  {%- comment -%}
    Collect all unique categories from books and count occurrences
    Handles both YAML array format and space-separated string format
    Filters out empty strings and invalid values
  {%- endcomment -%}
  {% assign all_categories = '' | split: '' %}
  {% assign category_counts = '' | split: '' %}

  {%- comment -%} First, collect all unique categories {%- endcomment -%}
  {% for item in collection %}
    {% if item.categories %}
      {% if item.categories.first %}
        {%- comment -%} It's already an array (YAML list format) {%- endcomment -%}
        {% assign item_categories = item.categories %}
      {% else %}
        {%- comment -%} It's a string, split by spaces {%- endcomment -%}
        {% assign item_categories = item.categories | split: ' ' %}
      {% endif %}
      {% for cat in item_categories %}
        {% assign cat_trimmed = cat | strip %}
        {% if cat_trimmed != '' and cat_trimmed != '[]' and cat_trimmed != '[' and cat_trimmed != ']' %}
          {% unless all_categories contains cat_trimmed %}
            {% assign all_categories = all_categories | push: cat_trimmed %}
          {% endunless %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}

  {%- comment -%} Count books for each category {%- endcomment -%}
  {% for category in all_categories %}
    {% assign count = 0 %}
    {% for item in collection %}
      {% if item.categories %}
        {% if item.categories.first %}
          {% assign item_categories = item.categories %}
        {% else %}
          {% assign item_categories = item.categories | split: ' ' %}
        {% endif %}
        {% for cat in item_categories %}
          {% assign cat_trimmed = cat | strip %}
          {% if cat_trimmed == category %}
            {% assign count = count | plus: 1 %}
            {% break %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}
    {% assign category_counts = category_counts | push: count %}
  {% endfor %}

  {%- comment -%} Keep categories and counts in parallel arrays - JavaScript will sort them {%- endcomment -%}
  {% assign sorted_categories = all_categories %}
  {% assign sorted_counts = category_counts %}

  {%- comment -%}
    Searchable multiselect dropdown for tags
  {%- endcomment -%}
  {% if all_categories.size > 0 %}
    <div class="book-filter-container" style="margin-bottom: 2rem; position: relative; max-width: 400px;">
      <div class="book-filter-dropdown">
        <div class="book-filter-input-wrapper" style="position: relative;">
          <input
            type="text"
            id="book-filter-search"
            class="book-filter-search"
            placeholder="Search and filter by tags..."
            autocomplete="off"
            style="width: 100%; padding: 0.5rem 2.5rem 0.5rem 1rem; border: 1px solid var(--global-divider-color); background: var(--global-bg-color); color: var(--global-text-color); border-radius: 4px; font-size: 0.9rem;"
          >
          <span
            class="book-filter-icon"
            style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--global-text-color-light);"
          >
            <i class="fa-solid fa-chevron-down"></i>
          </span>
        </div>
        <div
          class="book-filter-dropdown-menu"
          id="book-filter-dropdown-menu"
          style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 0.25rem; background: var(--global-bg-color); border: 1px solid var(--global-divider-color); border-radius: 4px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
        >
          <div class="book-filter-options" id="book-filter-options">
            {% for i in (0..sorted_categories.size) %}
              {% if i < sorted_categories.size %}
                {% assign category = sorted_categories[i] %}
                {% assign count = sorted_counts[i] %}
                <label
                  class="book-filter-option"
                  style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 1rem; cursor: pointer; transition: background 0.2s;"
                  data-category="{{ category }}"
                  data-count="{{ count }}"
                >
                  <span style="display: flex; align-items: center;">
                    <input
                      type="checkbox"
                      class="book-filter-checkbox"
                      value="{{ category }}"
                      style="margin-right: 0.5rem;"
                    >
                    <span>{{ category | replace: '-', ' ' | capitalize }}</span>
                  </span>
                  <span style="color: var(--global-text-color-light); font-size: 0.85rem; margin-left: 0.5rem;">{{ count }}</span>
                </label>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
      <div
        class="book-filter-selected"
        id="book-filter-selected"
        style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; min-height: 1.5rem; align-items: center;"
      >
        <!-- Selected tags will appear here -->
        <button
          id="book-filter-clear"
          class="book-filter-clear-btn"
          style="display: none; padding: 0.25rem 0.75rem; background: var(--global-text-color-light); color: var(--global-bg-color); border: 1px solid var(--global-divider-color); border-radius: 4px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;"
          title="Clear all filters"
        >
          Clear all
        </button>
      </div>
    </div>
  {% endif %}
  {%- comment -%}
    =========================
    FAVORITES (PINNED AT TOP)
    =========================
  {%- endcomment -%}

  {% assign has_favorites = false %}
  {% for item in collection %}
    {% if item.favorite == true %}
      {% assign has_favorites = true %}
      {% break %}
    {% endif %}
  {% endfor %}

  {% if has_favorites %}
    <h1>Favorites</h1>
    <ul class="favorites">
      {% for item in collection reversed %}
        {% if item.favorite == true %}
          <figure
            class="cover book-item"
            {% if item.categories %}
              {%- if item.categories.first -%}
                data-categories="{{ item.categories | join: ' ' }}"
              {%- else -%}
                data-categories="{{ item.categories }}"
              {%- endif -%}
            {% endif %}
          >
            <a class="cover-link" href="{{ item.url | relative_url }}">
              {% if item.cover %}
                <img
                  alt="{{ item.title }} cover"
                  src="{{ item.cover | prepend: page.covers | relative_url }}"
                  style="height:200px"
                >
              {% elsif item.olid %}
                <img
                  alt="{{ item.title }} cover"
                  src="http://covers.openlibrary.org/b/olid/{{ item.olid }}-L.jpg?default=false"
                  style="height:200px"
                >
              {% elsif item.isbn %}
                <img
                  alt="{{ item.title }} cover"
                  src="http://covers.openlibrary.org/b/isbn/{{ item.isbn }}-L.jpg?default=false"
                  style="height:200px"
                >
              {% endif %}

              {% if item.status %}
                {% assign statuses = 'abandoned,finished,interested,paused,queued,reading,reread' | split: ',' %}
                {% assign status = item.status | downcase | strip %}
                {% if statuses contains status %}
                  <figcaption class="{{ status }}">{{ status | upcase }}</figcaption>
                {% else %}
                  <figcaption class="uncategorized">UNCATEGORIZED</figcaption>
                {% endif %}
              {% else %}
                <figcaption class="uncategorized">UNCATEGORIZED</figcaption>
              {% endif %}
            </a>
          </figure>
        {% endif %}
      {% endfor %}
    </ul>
  {% endif %}

  {%- comment -%}
    =========================
    NON-FAVORITES (BY YEAR)
    =========================
  {%- endcomment -%}

  {% assign year = null %}
  {% for item in collection reversed %}
    {% unless item.favorite == true %}
      {% assign current_year = item.date | date: '%Y' %}

      {% if current_year != year %}
        {% unless forloop.first %}
          </ul>
        {% endunless %}
        <h1 id="y{{ current_year }}">
          <a href="{{ current_year | prepend: '/books/' | relative_url }}">{{ current_year }}</a>
        </h1>
        <ul>
          {% assign year = current_year %}
      {% endif %}

      <figure
        class="cover book-item"
        {% if item.categories %}
          {%- if item.categories.first -%}
            data-categories="{{ item.categories | join: ' ' }}"
          {%- else -%}
            data-categories="{{ item.categories }}"
          {%- endif -%}
        {% endif %}
      >
        <a class="cover-link" href="{{ item.url | relative_url }}">
          {% if item.cover %}
            <img
              alt="{{ item.title }} cover"
              src="{{ item.cover | prepend: page.covers | relative_url }}"
              style="height:200px"
            >
          {% elsif item.olid %}
            <img
              alt="{{ item.title }} cover"
              src="http://covers.openlibrary.org/b/olid/{{ item.olid }}-L.jpg?default=false"
              style="height:200px"
            >
          {% elsif item.isbn %}
            <img
              alt="{{ item.title }} cover"
              src="http://covers.openlibrary.org/b/isbn/{{ item.isbn }}-L.jpg?default=false"
              style="height:200px"
            >
          {% endif %}

          {% if item.status %}
            {% assign statuses = 'abandoned,finished,interested,paused,queued,reading,reread' | split: ',' %}
            {% assign status = item.status | downcase | strip %}
            {% if statuses contains status %}
              <figcaption class="{{ status }}">{{ status | upcase }}</figcaption>
            {% else %}
              <figcaption class="uncategorized">UNCATEGORIZED</figcaption>
            {% endif %}
          {% else %}
            <figcaption class="uncategorized">UNCATEGORIZED</figcaption>
          {% endif %}
        </a>
      </figure>
    {% endunless %}
  {% endfor %}
  </ul>
{% endif %}

<script src="{{ '/assets/js/book-filter.js' | relative_url | bust_file_cache }}" type="text/javascript"></script>

<style>
  .book-filter-dropdown {
    position: relative;
  }

  .book-filter-option:hover {
    background: var(--global-hover-color) !important;
  }

  .book-filter-option input[type='checkbox']:checked + span {
    font-weight: 600;
    color: var(--global-theme-color);
  }

  .book-filter-chip:hover {
    opacity: 0.9;
  }

  .book-filter-chip-remove:hover {
    opacity: 1 !important;
  }

  .book-filter-clear-btn:hover {
    background: var(--global-theme-color) !important;
    color: var(--global-bg-color) !important;
    border-color: var(--global-theme-color) !important;
  }

  .book-item.hidden {
    display: none;
  }

  .book-item {
    transition: opacity 0.3s ease;
  }

  .book-filter-dropdown-menu::-webkit-scrollbar {
    width: 8px;
  }

  .book-filter-dropdown-menu::-webkit-scrollbar-track {
    background: var(--global-bg-color);
  }

  .book-filter-dropdown-menu::-webkit-scrollbar-thumb {
    background: var(--global-divider-color);
    border-radius: 4px;
  }

  .book-filter-dropdown-menu::-webkit-scrollbar-thumb:hover {
    background: var(--global-text-color-light);
  }
</style>
